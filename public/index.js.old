var express = require('express');
var app = express();
var formidable = require('formidable');

var BASE_DIRECTORY = process.env['CAPTURE_DIRECTORY'] || './';

app.use(express.static('public'));

app.post('/clip/new', function(req, res) {
  var incomingForm = new formidable.IncomingForm();
  var clipIndex = 1;
  var city = 'c';
  var first = 'unknown';
  var last = 'unkonwn';
  var birth = '80';
  var index = 0;

  console.log("CLIP UPLOAD", incomingForm);

  incomingForm.on('error', function(err){
    console.log('error', err);
  })

  incomingForm.on('field', function(name, value){
    console.log('field', name, value);
    if ( name == 'city' )
      city = value.toLowerCase();
    if ( name == 'first' )
      first = value.toLowerCase();
    if ( name == 'last' )
      last = value.toLowerCase();
    if ( name == 'birth' )
      birth = parseInt(birth) % 100;
  })

  incomingForm.on('fileBegin', function(name, file){
    console.log("fileBegin", name, file.path, file.name );
    file.path = filename();
    console.log("fileBegin", name, file.path, file.name );
  })

  console.log("PARSE FILENAME");
  function filename() {
    var prefix = [city,last,first,birth].join('_');
    for ( ++index; fileExists(BASE_DIRECTORY+prefix+'_'+index+'.mov'); ++index )
      console.log("FOUND", BASE_DIRECTORY+prefix+'_'+index+'.mov');
    return BASE_DIRECTORY+prefix+'_'+index+'.mov';
  }

  console.log("PARSE FILE EXISTS");
  function fileExists(fileName) {
    try {
      fs.statSync(fileName);
      return true;
    } catch (e) {}
    return false;
  }
  console.log("DONE PARSING")
});

app.listen(8000);
